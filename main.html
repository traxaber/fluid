<link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Nunito&display=swap" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">

<button id="menubutton" onclick="toggleMenu()">☰</button>

<h1 id="title" style="font-family:'Nunito'; font-size:500%">FLUID</h1>

<body id="mainbody">
	

	<div id="buttonwrapper">
		<button onclick="topen(100)">top 100</button>
		<button onclick="topen(1000)">top 1000</button>
		<button onclick="newPrompt()">excerpt</button>
	</div>

	<br>

	<div id="promptwrapper">
		<div id="prompt" style="padding:15px; padding-left: 20px; padding-right: 20px"><span>The </span><span>quick </span><span>brown </span><span>fox </span><span>jumps </span><span>over </span><span>the </span><span>lazy </span><span>dog. </span></div>
	</div>

	<div id="wpmwrapper">
		<div style="float:right"><span id="wpm">0</span>&nbspWPM</div>
	</div>

	<br><br><br><br>

	<div id="inputwrapper" style="text-align:center">
		<div><input type="text" id="typeinput" autocorrect="off" autocapitalize="none" placeholder="Type Here" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Type Here'"></div>
		<button id="redobutton" onclick="redo()">redo</button>
	</div>

	<div id="popup" style="display: none">
		<br>
		<table style="width: 100%">
			<tr>
				<td>Dark Theme</td>
				<td>
					<label class="switch" style="float: right">
						<input id="darkMode" type="checkbox">
						<span class="slider"></span>
					</label>
				</td>
			</tr>
			<tr>
				<td>Show Live WPM</td>
				<td>
					<label class="switch" style="float: right">
						<input id="liveWPM" type="checkbox">
						<span class="slider"></span>
					</label>
				</td>
			</tr>
			<tr>
				<td>Epilepsy Mode</td>
				<td>
					<label class="switch" style="float: right">
						<input id="epilepsyMode" type="checkbox">
						<span class="slider"></span>
					</label>
				</td>
			</tr>
		</table>
	</div>

</body>

<script src="js/prompts.js"></script>
<script src="js/topPrompts.js"></script>

<script>

var root = document.documentElement;

var startTime = 0;

var popup = document.getElementById("popup");

var promptArr = ['The', 'quick', 'brown', 'fox', 'jumps', 'over', 'the', 'lazy', 'dog.'];
var promptDiv = document.getElementById('prompt');
var wpmSpan = document.getElementById('wpm');
var liveWPM = document.getElementById('liveWPM');
var darkMode = document.getElementById('darkMode');
var epilepsyMode = document.getElementById('epilepsyMode');

var completed = "";

var input = document.getElementById('typeinput');
var curr = 0;
var done = false;
var first = true;

var last = "top100"; // last chosen prompt mode

var live = false;
var dark = true;
var epilepsy = true;
if (typeof(Storage) !== "undefined"){
	live = localStorage.getItem("live");
	dark = localStorage.getItem("dark");
	epilepsy = localStorage.getItem("epilepsy");
	if(live == "true"){
		liveWPM.checked = true;
	} else {
		liveWPM.checked = false;
	}
	if(dark == "true"){
		darkMode.checked = true;
	} else {
		darkMode.checked = false;
	}
	if(epilepsy == "true"){
		epilepsyMode.checked = true;
	} else {
		epilepsyMode.checked = false;
	}
	setTheme();
}

input.focus(); // set cursor focus to input box

topen(100);

// listens to keystrokes in input box
input.addEventListener('input', function() {

	// set starting time to measure wpm
	if (curr === 0 && first){
		startTime = Date.now();
		first = false;
	}

    // Get cursor position
    var start = this.selectionStart;

    // Get last typed character
    var lastChar = String.fromCharCode(this.value.charCodeAt(start - 1));

    // clears input box if correct word is typed
    if((lastChar === ' ' && this.value == promptArr[curr]+" ") || (curr === promptArr.length-1 && this.value === promptArr[curr])) {
        // append to completed string
        completed += this.value;

        // update prompt word color indicators
		promptDiv.childNodes[curr].style.color = getComputedStyle(root).getPropertyValue("--completed-word");
		if (curr != promptArr.length-1){
			promptDiv.childNodes[curr+1].style.color = getComputedStyle(root).getPropertyValue("--current-word");
		}

		// calculate and display wpm
		if (live == "true"){
    		wpmSpan.innerHTML = ((completed.length/5)/((Date.now()-startTime)/60000)).toFixed(2);
		}
        
        // clear the board and increment promptArr index
        this.value = "";
        curr++;
    }

    // set background of input box to red if incorrect character is typed
    if (this.value.length > 0 && this.value !== promptArr[curr].substring(0, this.value.length)){
    	this.style.background = getComputedStyle(root).getPropertyValue("--wrong-word");
    } else {
		this.style.background = getComputedStyle(root).getPropertyValue("--base-2");
    }

    // end prompt if last word is typed (space not necessary)
    if (curr === promptArr.length && !done){
    	wpmSpan.innerHTML = ((completed.length/5)/((Date.now()-startTime)/60000)).toFixed(2);
		promptDiv.innerHTML += "✔️";
		done = true;
	}
	
	if(epilepsy == "true"){
		if (dark == "true"){
			dark = "false";
			if (typeof(Storage) !== "undefined"){
				localStorage.setItem("dark", "false");
			}
		} else {
			dark = "true";
			if (typeof(Storage) !== "undefined"){
				localStorage.setItem("dark", "true");
			}
		}
		setTheme();
	}

});

// sets new prompt, taken from prompts list, and resets variables
function newPrompt() {
	last = "newPrompt";
	var rand = Math.floor(Math.random() * prompts.length);
	promptArr = prompts[rand].split(' ');

	reset();
}

// sets new prompt, taken from top n words in english variable
function topen(n) {
	var bank = eval("top" + n.toString());
	last = "top" + n.toString();

	promptArr = [];
	for (i=0;i<49;i++){
		promptArr.push(bank[Math.floor(Math.random() * bank.length)]);
	}
	promptArr.push(bank[Math.floor(Math.random() * bank.length)]);

	reset();
}

// redo button
function redo(){
	if (last == "top100") topen(100);
	else if (last == "top1000") topen(1000);
	else newPrompt();
}

// reset necessary prompt variables
function reset(){
	promptDiv.innerHTML = "";
	for (var i=0; i<promptArr.length; i++){
		promptDiv.innerHTML += "<span>" + promptArr[i] + " </span>";
	}

	curr = 0;
	first = true;
	done = false;
    promptDiv.parentElement.style.background = getComputedStyle(root).getPropertyValue("--base-2");
	promptDiv.childNodes[0].style.color = getComputedStyle(root).getPropertyValue("--current-word");
	input.style.background = getComputedStyle(root).getPropertyValue("--base-2");
	wpmSpan.innerHTML = "?";
	completed = "";
	input.value = "";
	input.focus();
}

function toggleMenu(){
	if (popup.style.display === "none") {
	  	popup.style.display = "block";
  	} else {
	  	popup.style.display = "none";
  	}
}

liveWPM.addEventListener('change', function() {
	if(this.checked){
		live = "true";
		if (typeof(Storage) !== "undefined"){
			localStorage.setItem("live", "true");
		}
	} else {
		live = "false";
		if (typeof(Storage) !== "undefined"){
			localStorage.setItem("live", "false");
		}
	}
});

darkMode.addEventListener('change', function() {
	if(this.checked){
		dark = "true";
		if (typeof(Storage) !== "undefined"){
			localStorage.setItem("dark", "true");
		}
	} else {
		dark = "false";
		if (typeof(Storage) !== "undefined"){
			localStorage.setItem("dark", "false");
		}
	}
	setTheme();
});

epilepsyMode.addEventListener('change', function() {
	if(this.checked){
		epilepsy = "true";
		if (typeof(Storage) !== "undefined"){
			localStorage.setItem("epilepsy", "true");
		}
	} else {
		epilepsy = "false";
		if (typeof(Storage) !== "undefined"){
			localStorage.setItem("epilepsy", "false");
		}
	}
});

function setTheme(){
	if(dark == "true"){
		darkMode.checked = true;
		root.style.setProperty("--base-1", getComputedStyle(root).getPropertyValue("--dark-1"));
		root.style.setProperty("--base-2", getComputedStyle(root).getPropertyValue("--dark-2"));
		root.style.setProperty("--base-3", getComputedStyle(root).getPropertyValue("--dark-3"));
		root.style.setProperty("--text", getComputedStyle(root).getPropertyValue("--white-1"));
	} else {
		darkMode.checked = false;
		root.style.setProperty("--base-1", getComputedStyle(root).getPropertyValue("--light-1"));
		root.style.setProperty("--base-2", getComputedStyle(root).getPropertyValue("--light-2"));
		root.style.setProperty("--base-3", getComputedStyle(root).getPropertyValue("--light-3"));
		root.style.setProperty("--text", getComputedStyle(root).getPropertyValue("--black-1"));
	}
	promptDiv.parentElement.style.background = getComputedStyle(root).getPropertyValue("--base-2");
	input.style.background = getComputedStyle(root).getPropertyValue("--base-2");
	if(!epilepsy){
		promptDiv.childNodes[0].style.color = getComputedStyle(root).getPropertyValue("--current-word");
	}
}

</script>
